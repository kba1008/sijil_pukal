<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencetak Sijil Pukal Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <!-- Cikgu AI: Menambah font 'Inter' untuk gaya korporat moden -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Corporate Header Design */
        header {
            text-align: center;
            background: var(--bg-card);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        h1 {
            color: var(--primary-dark);
            font-size: 2em;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1em;
        }

        /* Card Styling - Clean & Minimal */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
        }

        .card-title {
            color: var(--text-main);
            margin-bottom: 24px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
            font-size: 1.25em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .upload-box {
            flex: 1;
            min-width: 250px;
            padding: 40px 20px;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-box:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .upload-box i {
            font-size: 2.5em;
            color: var(--primary);
            margin-bottom: 15px;
            display: block;
        }

        .upload-box p {
            color: var(--text-muted);
            font-weight: 500;
            margin: 5px 0;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        #templatePreviewContainer {
            margin-top: 20px;
            text-align: center;
            overflow-x: auto;
            background: #f1f5f9;
            padding: 20px;
            border-radius: 8px;
        }

        #templatePreview {
            display: inline-block;
            position: relative;
            max-width: 100%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background: white;
            line-height: 0;
        }

        /* Cikgu AI: Grid Overlay untuk Ketepatan Tinggi */
        .grid-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            background-size: 20px 20px;
            background-image:
                linear-gradient(to right, rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,0,0,0.1) 1px, transparent 1px);
            z-index: 5;
            display: none;
        }
        .grid-overlay.active { display: block; }

        #certificateTemplate {
            max-width: 100%;
            max-height: 600px;
            display: none;
        }

        #headersContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border);
            min-height: 60px;
        }

        .draggable-header {
            padding: 8px 16px;
            background: white;
            color: var(--text-main);
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: move;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }

        .draggable-header:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .drop-zone {
            position: absolute;
            /* Cikgu AI: Updated for resizable box support */
            min-width: 50px;
            min-height: 30px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed var(--primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #000;
            font-weight: bold;
            cursor: move;
            z-index: 10;
            
            /* Cikgu AI: Fix for text wrapping and spacing */
            white-space: pre-wrap; /* Preserves Excel spaces and newlines */
            word-break: normal; /* Prevents awkward word splitting */
            overflow-wrap: break-word; /* Wraps long words only if necessary */
            line-height: 1.2;
            user-select: none;
            transition: background 0.2s;
            
            /* Resizing capabilities */
            resize: both;
            overflow: hidden;
            width: 200px;
        }

        /* Cikgu AI: Style Khas untuk Selected Zone dengan Garisan Grid */
        .drop-zone:hover, .drop-zone.selected-zone {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #ef4444;
            z-index: 20;
            /* Grid Lines Visual (Crosshair) */
            background-image: 
                linear-gradient(to right, transparent 49%, rgba(255,0,0,0.4) 50%, transparent 51%),
                linear-gradient(to bottom, transparent 49%, rgba(255,0,0,0.4) 50%, transparent 51%);
            background-size: 100% 100%;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.5);
        }

        /* Helper label for guidelines */
        .drop-zone.selected-zone::after {
            content: '‚úõ Pusat';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #ef4444;
            background: white;
            padding: 1px 4px;
            border-radius: 4px;
            pointer-events: none;
        }

        .drop-zone .remove-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: #ef4444;
            color: white;
            border: none;
            border-bottom-left-radius: 4px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            z-index: 30;
        }

        #styleEditor {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .style-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .style-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .style-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .style-input {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
        }

        .style-input:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }

        /* Button Refinement */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        } 

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { background: var(--primary-dark); }

        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover { background: #059669; }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-warning:hover { background: #d97706; }

        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover { background: #dc2626; }

        .btn-secondary {
            background: #fff;
            color: var(--text-main);
            border: 1px solid #cbd5e1;
        }
        .btn-secondary:hover { background: #f1f5f9; }

        /* Cikgu AI: Social Share Button Style */
        .btn-info {
            background: #0ea5e9;
            color: white;
        }
        .btn-info:hover { background: #0284c7; }

        /* Preview Section */
        #previewSection {
            margin-top: 30px;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .certificate-preview {
            width: 100%;
            max-width: 800px;
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            page-break-after: always;
            line-height: 0;
        }
        
        .certificate-preview img.bg-img {
            width: 100%;
            height: auto;
            display: block;
        }

        .preview-field {
            position: absolute;
            line-height: 1.2;
            /* Cikgu AI: Match drop-zone formatting */
            white-space: pre-wrap;
            word-break: normal;
            overflow-wrap: break-word;
            /* transform removed to support top-left positioning */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hidden {
            display: none !important;
        }

        .status-message {
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95em;
            display: flex;
            align-items: center;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .card, header, .upload-section, .btn-group, #styleEditor {
                display: none;
            }
            
            .preview-container {
                display: block;
            }
            
            .certificate-preview {
                width: 100% !important;
                max-width: none !important;
                height: auto !important;
                page-break-after: always;
                border: none;
                box-shadow: none;
            }
            
            .preview-field {
                background: transparent !important;
            }
        }

        @media (max-width: 768px) {
            .upload-section {
                flex-direction: column;
            }
            .certificate-preview {
                width: 100%;
            }
            button {
                width: 100%;
                justify-content: center;
            }
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ®Ô∏è Pencetak Sijil Pukal Pro</h1>
            <p class="subtitle">Solusi Profesional untuk Penjanaan Sijil Pukal & Data Excel</p>
            <p style="margin-top: 10px; font-size: 0.85em; color: var(--text-muted); font-weight: 600; background: #f1f5f9; padding: 4px 12px; border-radius: 20px; display: inline-block;">Versi Enterprise 2.1 (Pintar - Teks Boleh Edit)</p>
        </header>

        <div class="card">
            <h2 class="card-title"><span>üìÅ</span> 1. Muat Naik Template Sijil</h2>
            <div class="upload-section">
                <div class="upload-box" id="templateDropZone">
                    <i style="font-style: normal; font-size: 2em;">üñºÔ∏è</i>
                    <p>Klik atau Seret Template Sijil Di Sini</p>
                    <p style="font-size: 0.85em; opacity: 0.7;">(Sokongan: JPG, PNG, PDF)</p>
                    <input type="file" id="templateUpload" accept="image/*,.pdf">
                </div>
            </div>
            <div id="templatePreviewContainer" class="hidden">
                <h3 style="margin-bottom: 15px; color: var(--text-main);">üì∏ Paparan Template:</h3>
                <div id="templatePreview">
                    <!-- Grid Overlay added by Cikgu AI -->
                    <div id="gridOverlay" class="grid-overlay"></div>
                    <img id="certificateTemplate" alt="Template Sijil">
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title"><span>üìä</span> 2. Muat Naik Pangkalan Data</h2>
            <div class="upload-section">
                <div class="upload-box" id="excelDropZone">
                    <i style="font-style: normal; font-size: 2em;">üìã</i>
                    <p>Klik atau Seret Fail Excel Di Sini</p>
                    <p style="font-size: 0.85em; opacity: 0.7;">(Sokongan: XLSX, XLS, CSV)</p>
                    <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv">
                </div>
            </div>

            <!-- Cikgu AI: Pilihan Link Google Sheet -->
            <div style="text-align: center; margin: 15px 0; font-weight: bold; color: var(--text-muted); font-size: 0.9em;">- ATAU GUNAKAN LINK -</div>
            
            <div class="style-controls" style="justify-content: center; gap: 10px; margin-bottom: 25px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <input type="text" id="gSheetUrl" class="style-input" style="flex:1; min-width: 250px;" placeholder="Tampal Link Google Sheet (Mesti 'Published to Web')">
                <button class="btn-info" id="loadGSheetBtn" style="padding: 8px 16px; font-size: 0.9em;">‚òÅÔ∏è Muat Link</button>
            </div>
            
            <div id="excelStatus" class="hidden"></div>
            
            <div id="mappingSection" class="hidden">
                <h3 style="font-size: 1.1em; color: var(--primary-dark); margin-top: 20px;">üéØ 3. Pemetaan Medan Data</h3>
                <p style="margin: 10px 0; color: var(--text-muted); font-size: 0.95em;">
                    Sila <strong>heret (drag)</strong> label di bawah ke atas template sijil. <br> 
                    <span style="color: var(--primary); font-weight: 600;">‚ÑπÔ∏è Tip Pro:</span> Boleh ubah saiz kotak (resize) untuk memuatkan teks panjang.
                </p>
                
                <div id="headersContainer"></div>

                <!-- Style Editor -->
                <div id="styleEditor" class="hidden">
                    <h4 style="margin-bottom: 15px; color: var(--primary); display: flex; align-items: center; gap: 8px;">‚ú® Tetapan Font: <span id="editingFieldName" style="font-weight: 800; color: var(--text-main);">-</span></h4>
                    <div class="style-controls">
                        <div class="style-group">
                            <label>Saiz (px)</label>
                            <input type="number" id="editFontSize" class="style-input" value="20" min="8" max="200">
                        </div>
                        <div class="style-group">
                            <label>Warna</label>
                            <input type="color" id="editColor" class="style-input" value="#000000" style="height: 38px; width: 60px; padding: 2px;">
                        </div>
                        <div class="style-group">
                            <label>Tipografi</label>
                            <select id="editFontFamily" class="style-input">
                                <option value="'Segoe UI', sans-serif">Segoe UI (Standard)</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Arial', sans-serif">Arial</option>
                                <option value="'Courier New', monospace">Courier New</option>
                                <option value="'Georgia', serif">Georgia</option>
                                <option value="'Verdana', sans-serif">Verdana</option>
                                <option value="cursive">Tulisan Tangan (Cursive)</option>
                                <option value="'Helvetica', sans-serif">Helvetica</option>
                                <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                                <option value="'Arial Black', sans-serif">Arial Black</option>
                                <option value="'Impact', sans-serif">Impact</option>
                                <option value="'Tahoma', sans-serif">Tahoma</option>
                                <option value="'Geneva', sans-serif">Geneva</option>
                                <option value="'Century Gothic', sans-serif">Century Gothic</option>
                                <option value="'Lucida Grande', sans-serif">Lucida Grande</option>
                                <option value="'Optima', sans-serif">Optima</option>
                                <option value="'Avant Garde', sans-serif">Avant Garde</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                <option value="'Lato', sans-serif">Lato</option>
                                <option value="'Montserrat', sans-serif">Montserrat</option>
                                <option value="'Oswald', sans-serif">Oswald</option>
                                <option value="'Raleway', sans-serif">Raleway</option>
                                <option value="'Merriweather', serif">Merriweather</option>
                                <option value="'Noto Sans', sans-serif">Noto Sans</option>
                                <option value="'Poppins', sans-serif">Poppins</option>
                                <option value="'Ubuntu', sans-serif">Ubuntu</option>
                                <option value="'Playfair Display', serif">Playfair Display</option>
                                <option value="'Roboto Condensed', sans-serif">Roboto Condensed</option>
                                <option value="'Roboto Slab', serif">Roboto Slab</option>
                                <option value="'Lora', serif">Lora</option>
                                <option value="'PT Sans', sans-serif">PT Sans</option>
                                <option value="'PT Serif', serif">PT Serif</option>
                                <option value="'Droid Sans', sans-serif">Droid Sans</option>
                                <option value="'Droid Serif', serif">Droid Serif</option>
                                <option value="'Source Sans Pro', sans-serif">Source Sans Pro</option>
                                <option value="'Nunito', sans-serif">Nunito</option>
                                <option value="'Titillium Web', sans-serif">Titillium Web</option>
                                <option value="'Muli', sans-serif">Muli</option>
                                <option value="'Arvo', serif">Arvo</option>
                                <option value="'Fjalla One', sans-serif">Fjalla One</option>
                                <option value="'Josefin Sans', sans-serif">Josefin Sans</option>
                                <option value="'Abril Fatface', cursive">Abril Fatface</option>
                                <option value="'Ubuntu Condensed', sans-serif">Ubuntu Condensed</option>
                                <option value="'Archivo Narrow', sans-serif">Archivo Narrow</option>
                                <option value="'Yanone Kaffeesatz', sans-serif">Yanone Kaffeesatz</option>
                                <option value="'Exo', sans-serif">Exo</option>
                                <option value="'Bitter', serif">Bitter</option>
                                <option value="'Pacifico', cursive">Pacifico</option>
                                <option value="'Dancing Script', cursive">Dancing Script</option>
                                <option value="'Shadows Into Light', cursive">Shadows Into Light</option>
                                <option value="'Lobster', cursive">Lobster</option>
                                <option value="'Indie Flower', cursive">Indie Flower</option>
                                <option value="'Anton', sans-serif">Anton</option>
                                <option value="'Oxygen', sans-serif">Oxygen</option>
                                <option value="'Questrial', sans-serif">Questrial</option>
                                <option value="'Signika', sans-serif">Signika</option>
                                <option value="'Varela Round', sans-serif">Varela Round</option>
                                <option value="'Maven Pro', sans-serif">Maven Pro</option>
                                <option value="'Cuprum', sans-serif">Cuprum</option>
                                <option value="'Alegreya', serif">Alegreya</option>
                                <option value="'Francois One', sans-serif">Francois One</option>
                                <option value="'Rokkitt', serif">Rokkitt</option>
                                <option value="'Pathway Gothic One', sans-serif">Pathway Gothic One</option>
                                <option value="'Cantarell', sans-serif">Cantarell</option>
                                <option value="'Cardo', serif">Cardo</option>
                                <option value="'Vollkorn', serif">Vollkorn</option>
                                <option value="'Ruda', sans-serif">Ruda</option>
                                <option value="'Old Standard TT', serif">Old Standard TT</option>
                                <option value="'Crimson Text', serif">Crimson Text</option>
                                <option value="'Volkhov', serif">Volkhov</option>
                                <option value="'Play', sans-serif">Play</option>
                                <option value="'Philosopher', sans-serif">Philosopher</option>
                                <option value="'Didact Gothic', sans-serif">Didact Gothic</option>
                                <option value="'Jura', sans-serif">Jura</option>
                                <option value="'Sintony', sans-serif">Sintony</option>
                                <option value="'Cabin', sans-serif">Cabin</option>
                                <option value="'Quicksand', sans-serif">Quicksand</option>
                                <option value="'Inconsolata', monospace">Inconsolata</option>
                                <option value="'Coda', cursive">Coda</option>
                                <option value="'Share Tech Mono', monospace">Share Tech Mono</option>
                                <option value="'Anonymous Pro', monospace">Anonymous Pro</option>
                                <option value="'Oxygen Mono', monospace">Oxygen Mono</option>
                                <option value="'VT323', monospace">VT323</option>
                                <option value="'Abel', sans-serif">Abel</option>
                                <option value="'Satisfy', cursive">Satisfy</option>
                                <option value="'Cookie', cursive">Cookie</option>
                                <option value="'Great Vibes', cursive">Great Vibes</option>
                                <option value="'Kaushan Script', cursive">Kaushan Script</option>
                                <option value="'Sofia', cursive">Sofia</option>
                                <option value="'Sacramento', cursive">Sacramento</option>
                                <option value="'Amatic SC', cursive">Amatic SC</option>
                                <option value="'Cinzel', serif">Cinzel</option>
                                <option value="'Righteous', cursive">Righteous</option>
                                <option value="'Fredoka One', cursive">Fredoka One</option>
                                <option value="'Bangers', cursive">Bangers</option>
                                <option value="'Luckiest Guy', cursive">Luckiest Guy</option>
                                <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                                <option value="'Palatino Linotype', serif">Palatino Linotype</option>
                                <option value="'Book Antiqua', serif">Book Antiqua</option>
                                <option value="'Franklin Gothic Medium', sans-serif">Franklin Gothic Medium</option>
                            </select>
                        </div>
                        
                        <!-- Cikgu AI: Alignment Controls -->
                        <div class="style-group">
                            <label>Susunan (H)</label>
                            <select id="editTextAlign" class="style-input">
                                <option value="left">Kiri</option>
                                <option value="center" selected>Tengah</option>
                                <option value="right">Kanan</option>
                                <option value="justify">Justify</option>
                            </select>
                        </div>
                        <div class="style-group">
                            <label>Susunan (V)</label>
                            <select id="editVerticalAlign" class="style-input">
                                <option value="flex-start">Atas</option>
                                <option value="center" selected>Tengah</option>
                                <option value="flex-end">Bawah</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-warning" id="resetMappingBtn">
                        üîÑ Reset Kedudukan
                    </button>
                    <button class="btn-secondary" id="toggleGridBtn">
                         üìè Grid Panduan
                    </button>
                    <button class="btn-primary" id="generateBtnMain">
                        üé® Jana Preview
                    </button>
                </div>
            </div>
        </div>

        <div class="card hidden" id="previewCard">
            <h2 class="card-title"><span>üëÄ</span> 4. Hasil & Cetakan</h2>
            <div class="btn-group">
                <button class="btn-primary" id="generateBtn">üé® Jana Semula</button>
                <button class="btn-success" id="printBtn">üñ®Ô∏è Cetak Semua</button>
                <button class="btn-secondary" id="downloadPdfBtn">üì• Muat Turun PDF (Editable)</button>
                <button class="btn-info" id="shareBtn">üîó Kongsi PDF</button>
                <button class="btn-danger" id="clearAllBtn">üóëÔ∏è Padam Semua</button>
            </div>
            
            <div id="previewSection">
                <div class="preview-container" id="previewContainer"></div>
            </div>
        </div>
    </div>

    <!-- SheetJS Library untuk baca Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF untuk export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Cikgu AI: html2canvas dikekalkan untuk legacy support jika perlu -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let templateDataURL = null;
        let excelData = null;
        let headers = [];
        let dropZones = [];
        let certificatesGenerated = false;
        let selectedDropZone = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            registerServiceWorker();
            setupStyleEditorListeners();
        });

        function setupEventListeners() {
            // Template upload
            document.getElementById('templateUpload').addEventListener('change', handleTemplateUpload);
            document.getElementById('templateDropZone').addEventListener('click', () => document.getElementById('templateUpload').click());
            
            // Excel upload
            document.getElementById('excelUpload').addEventListener('change', handleExcelUpload);
            document.getElementById('excelDropZone').addEventListener('click', () => document.getElementById('excelUpload').click());
            
            // Cikgu AI: Google Sheet Load
            document.getElementById('loadGSheetBtn').addEventListener('click', handleGSheetLoad);

            // Generate certificates
            document.getElementById('generateBtn').addEventListener('click', generateCertificates);
            document.getElementById('generateBtnMain').addEventListener('click', generateCertificates);
            
            // Print
            document.getElementById('printBtn').addEventListener('click', printCertificates);
            
            // Download PDF
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadAsPDF);
            
            // Cikgu AI: Share PDF
            document.getElementById('shareBtn').addEventListener('click', shareCertificates);

            // Clear all
            document.getElementById('clearAllBtn').addEventListener('click', clearAll);
            
            // Reset mapping
            document.getElementById('resetMappingBtn').addEventListener('click', resetMapping);
            
            // Cikgu AI: Toggle Grid
            document.getElementById('toggleGridBtn').addEventListener('click', toggleGrid);

            // Drag and drop for template
            setupDragDrop('templateDropZone', handleTemplateUpload);
            setupDragDrop('excelDropZone', handleExcelUpload);
            
            // Cikgu AI: Sokongan Keyboard untuk pergerakan field
            document.addEventListener('keydown', handleKeyboardMove);
        }

        function setupStyleEditorListeners() {
            const fontSizeInput = document.getElementById('editFontSize');
            const colorInput = document.getElementById('editColor');
            const fontFamilyInput = document.getElementById('editFontFamily');
            const textAlignInput = document.getElementById('editTextAlign');
            const verticalAlignInput = document.getElementById('editVerticalAlign');

            const updateStyle = () => {
                if (selectedDropZone) {
                    fontSizeInput.disabled = false;
                    selectedDropZone.style.fontSize = fontSizeInput.value + 'px';
                    selectedDropZone.style.color = colorInput.value;
                    selectedDropZone.style.fontFamily = fontFamilyInput.value;
                    
                    // Alignment Logic
                    const hAlign = textAlignInput.value;
                    const vAlign = verticalAlignInput.value;
                    
                    selectedDropZone.style.textAlign = hAlign;
                    selectedDropZone.style.alignItems = vAlign;
                    
                    // Auto-adjust justify-content based on text-align for single lines
                    if (hAlign === 'left' || hAlign === 'justify') {
                        selectedDropZone.style.justifyContent = 'flex-start';
                    } else if (hAlign === 'right') {
                        selectedDropZone.style.justifyContent = 'flex-end';
                    } else {
                        selectedDropZone.style.justifyContent = 'center';
                    }
                    
                    // Simpan data dalam dataset untuk rujukan nanti
                    selectedDropZone.dataset.fontSize = fontSizeInput.value;
                    selectedDropZone.dataset.color = colorInput.value;
                    selectedDropZone.dataset.fontFamily = fontFamilyInput.value;
                    selectedDropZone.dataset.textAlign = hAlign;
                    selectedDropZone.dataset.verticalAlign = vAlign;
                }
            };

            fontSizeInput.addEventListener('input', updateStyle);
            colorInput.addEventListener('input', updateStyle);
            fontFamilyInput.addEventListener('change', updateStyle);
            textAlignInput.addEventListener('change', updateStyle);
            verticalAlignInput.addEventListener('change', updateStyle);
        }
        
        // Cikgu AI: Fungsi Pergerakan Keyboard (Mouse & Arrow Keys)
        function handleKeyboardMove(e) {
            if (!selectedDropZone) return;
            
            // Jangan ganggu jika user sedang menaip input nilai
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            // Hanya respon pada Arrow Keys
            if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) return;

            e.preventDefault(); // Elak scroll page

            let x = parseInt(selectedDropZone.style.left || 0);
            let y = parseInt(selectedDropZone.style.top || 0);
            
            // Shift = Gerak Laju (10px), Biasa = Gerak Tepat (1px)
            const step = e.shiftKey ? 10 : 1;

            switch(e.key) {
                case 'ArrowLeft': x -= step; break;
                case 'ArrowRight': x += step; break;
                case 'ArrowUp': y -= step; break;
                case 'ArrowDown': y += step; break;
            }

            selectedDropZone.style.left = x + 'px';
            selectedDropZone.style.top = y + 'px';
        }
        
        // Cikgu AI: Toggle Grid Function
        function toggleGrid() {
            const grid = document.getElementById('gridOverlay');
            grid.classList.toggle('active');
            const btn = document.getElementById('toggleGridBtn');
            btn.textContent = grid.classList.contains('active') ? 'üìè Tutup Grid' : 'üìè Grid Panduan';
        }

        // ============================================
        // TEMPLATE HANDLING
        // ============================================
        function handleTemplateUpload(event) {
            const file = event.target.files?.[0] || event.dataTransfer?.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                templateDataURL = e.target.result;
                const img = document.getElementById('certificateTemplate');
                img.src = templateDataURL;
                img.style.display = 'block';
                
                document.getElementById('templatePreviewContainer').classList.remove('hidden');
                
                showStatus('Template berjaya dimuat naik!', 'success');
                
                // Reset drop zones if template changes
                resetMapping();
            };
            reader.readAsDataURL(file);
        }

        // ============================================
        // EXCEL & DATA HANDLING (UPDATED)
        // ============================================
        
        // Helper to process workbook object (from file or url)
        function processWorkbook(workbook) {
             try {
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                if (jsonData.length === 0) {
                    showStatus('Fail data kosong!', 'error');
                    return;
                }
                
                headers = jsonData[0]; // First row is headers
                excelData = jsonData.slice(1); // Rest is data
                
                document.getElementById('excelStatus').innerHTML = `
                    <div class="status-success">
                        ‚úÖ Berjaya muat naik: ${excelData.length} rekod dengan ${headers.length} medan
                    </div>
                `;
                document.getElementById('excelStatus').classList.remove('hidden');
                
                displayHeadersForMapping();
                document.getElementById('mappingSection').classList.remove('hidden');
                
                showStatus(`Berjaya baca ${excelData.length} rekod!`, 'success');
            } catch (error) {
                 console.error('Error processing workbook:', error);
                 showStatus('Ralat memproses data: ' + error.message, 'error');
            }
        }

        function handleExcelUpload(event) {
            const file = event.target.files?.[0] || event.dataTransfer?.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    processWorkbook(workbook);
                } catch (error) {
                    console.error('Error reading Excel:', error);
                    showStatus('Ralat membaca fail Excel: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Cikgu AI: Function to load Google Sheet via CSV Export
        async function handleGSheetLoad() {
            const urlInput = document.getElementById('gSheetUrl').value;
            // Extract ID: looks for /d/ID/ in url
            const idMatch = urlInput.match(times => /\/d\/([a-zA-Z0-9-_]+)/.exec(urlInput));
            // Fix regex call safely
            const safeMatch = urlInput.match(/\/d\/([a-zA-Z0-9-_]+)/);

            if (!safeMatch) {
                showStatus('Link Google Sheet tidak sah! Sila guna link standard.', 'error');
                return;
            }
            
            const sheetId = safeMatch[1];
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            
            showStatus('‚è≥ Sedang memuat turun data dari Google Sheet...', 'info');
            
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error('Gagal akses URL (CORS/Private)');
                const csvText = await response.text();
                
                // Parse CSV using XLSX
                const workbook = XLSX.read(csvText, {type: 'string'});
                processWorkbook(workbook);
                
            } catch (error) {
                console.error(error);
                showStatus('Gagal: Pastikan Sheet "Published to Web" (File > Share > Publish to web) atau Public.', 'error');
            }
        }

        function displayHeadersForMapping() {
            const container = document.getElementById('headersContainer');
            container.innerHTML = '';
            
            headers.forEach((header, index) => {
                const headerElement = document.createElement('div');
                headerElement.className = 'draggable-header';
                headerElement.draggable = true;
                headerElement.dataset.headerIndex = index;
                headerElement.textContent = header;
                
                // Drag start
                headerElement.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', index);
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                container.appendChild(headerElement);
            });
            
            // Setup drop zones on template preview
            const templatePreview = document.getElementById('templatePreview');
            templatePreview.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            templatePreview.addEventListener('drop', function(e) {
                e.preventDefault();
                
                const headerIndex = e.dataTransfer.getData('text/plain');
                if (headerIndex === '') return;
                
                // Calculate position relative to template preview
                const rect = templatePreview.getBoundingClientRect();
                // We need to account for scroll positions if any
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                createDropZone(parseInt(headerIndex), x, y);
            });
        }

        // ============================================
        // DROP ZONE HANDLING (UPDATED)
        // ============================================
        function createDropZone(headerIndex, x, y) {
            const templatePreview = document.getElementById('templatePreview');
            
            // Cikgu AI: Create resizable drop zone
            const dropZone = document.createElement('div');
            dropZone.className = 'drop-zone';
            dropZone.dataset.headerIndex = headerIndex;
            
            // Center the initial box on the mouse (assuming default width 200px)
            const defaultWidth = 200;
            const adjustedX = x - (defaultWidth / 2);

            dropZone.style.left = adjustedX + 'px';
            dropZone.style.top = y + 'px';
            dropZone.style.width = defaultWidth + 'px';
            dropZone.style.height = '50px'; // Cikgu AI: Fixed height for auto-font calculation

            dropZone.textContent = headers[headerIndex];
            
            // Default Styles (Will be overridden by Auto Size immediately)
            dropZone.style.fontSize = '20px';
            dropZone.style.color = '#000000';
            dropZone.style.fontFamily = "'Segoe UI', sans-serif";
            dropZone.style.textAlign = 'center';
            dropZone.style.justifyContent = 'center';
            dropZone.style.alignItems = 'center';
            
            // Store defaults in dataset
            dropZone.dataset.fontSize = '20';
            dropZone.dataset.color = '#000000';
            dropZone.dataset.fontFamily = "'Segoe UI', sans-serif";
            dropZone.dataset.textAlign = 'center';
            dropZone.dataset.verticalAlign = 'center';
            
            // Cikgu AI: Auto Font Size Logic via ResizeObserver
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    // Logic: Font size ~ 45% of box height to fit text nicely
                    const h = entry.contentRect.height;
                    if(h < 15) return; // ignore too small
                    
                    const autoFontSize = Math.max(10, Math.floor(h * 0.45)); // 0.45 factor allows padding & descenders
                    
                    dropZone.style.fontSize = autoFontSize + 'px';
                    dropZone.dataset.fontSize = autoFontSize;
                    
                    // Sync with editor if selected
                    if(selectedDropZone === dropZone) {
                        const fontSizeInput = document.getElementById('editFontSize');
                        if(fontSizeInput) fontSizeInput.value = autoFontSize;
                    }
                }
            });
            resizeObserver.observe(dropZone);

            // SELECT FUNCTION (Show Editor)
            dropZone.addEventListener('click', function(e) {
                e.stopPropagation();
                selectZone(dropZone);
            });

            // DRAGGABLE LOGIC
            dropZone.addEventListener('mousedown', function(e) {
                if (e.target.className === 'remove-btn') return;
                
                // Select automatically on drag start
                selectZone(dropZone);
                
                const offsetX = e.clientX - dropZone.getBoundingClientRect().left;
                const offsetY = e.clientY - dropZone.getBoundingClientRect().top;
                
                function onMouseMove(e) {
                    const rect = templatePreview.getBoundingClientRect();
                    let newX = e.clientX - rect.left - offsetX;
                    let newY = e.clientY - rect.top - offsetY;
                    
                    // Keep within bounds
                    newX = Math.max(0, Math.min(newX, rect.width - dropZone.offsetWidth));
                    newY = Math.max(0, Math.min(newY, rect.height - dropZone.offsetHeight));
                    
                    dropZone.style.left = newX + 'px';
                    dropZone.style.top = newY + 'px';
                }
                
                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '√ó';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (selectedDropZone === dropZone) {
                     document.getElementById('styleEditor').classList.add('hidden');
                     selectedDropZone = null;
                }
                dropZone.remove();
            });
            dropZone.appendChild(removeBtn);
            
            templatePreview.appendChild(dropZone);
            dropZones.push(dropZone);
            
            // Select newly created zone
            selectZone(dropZone);
        }

        function selectZone(zone) {
            // Remove active class from old zone
            if (selectedDropZone) selectedDropZone.classList.remove('selected-zone');
            
            selectedDropZone = zone;
            selectedDropZone.classList.add('selected-zone');
            
            // Show editor
            const editor = document.getElementById('styleEditor');
            editor.classList.remove('hidden');
            
            // Update Editor Values from Zone
            document.getElementById('editingFieldName').textContent = headers[zone.dataset.headerIndex];
            document.getElementById('editFontSize').value = zone.dataset.fontSize || 20;
            document.getElementById('editColor').value = zone.dataset.color || '#000000';
            document.getElementById('editFontFamily').value = zone.dataset.fontFamily || "'Segoe UI', sans-serif";
            document.getElementById('editTextAlign').value = zone.dataset.textAlign || 'center';
            document.getElementById('editVerticalAlign').value = zone.dataset.verticalAlign || 'center';
        }

        function resetMapping() {
            const templatePreview = document.getElementById('templatePreview');
            const dropZones = templatePreview.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => zone.remove());
            
            selectedDropZone = null;
            document.getElementById('styleEditor').classList.add('hidden');
            showStatus('Semua kedudukan telah direset', 'info');
        }

        // ============================================
        // CERTIFICATE GENERATION (UPDATED Logic)
        // ============================================
        function generateCertificates() {
            if (!templateDataURL) {
                showStatus('Sila muat naik template sijil dahulu!', 'error');
                return;
            }
            
            if (!excelData || excelData.length === 0) {
                showStatus('Sila muat naik fail Excel dahulu!', 'error');
                return;
            }
            
            const templatePreview = document.getElementById('templatePreview');
            const dropZones = templatePreview.querySelectorAll('.drop-zone');
            const templateImg = document.getElementById('certificateTemplate');
            
            if (dropZones.length === 0) {
                showStatus('Sila letakkan field pada template dahulu!', 'error');
                return;
            }
            
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';
            
            // Get Mapping Dimensions (Original reference)
            const mapWidth = templatePreview.offsetWidth;
            const mapHeight = templatePreview.offsetHeight;
            
            // Map field positions as PERCENTAGES to avoid position jumping
            const fieldConfigs = Array.from(dropZones).map(zone => {
                return {
                    headerIndex: parseInt(zone.dataset.headerIndex),
                    leftPct: ((zone.offsetLeft) / mapWidth) * 100,
                    topPct: ((zone.offsetTop) / mapHeight) * 100,
                    widthPct: (zone.offsetWidth / mapWidth) * 100,
                    heightPct: (zone.offsetHeight / mapHeight) * 100,
                    fontSize: parseInt(zone.dataset.fontSize),
                    color: zone.dataset.color,
                    fontFamily: zone.dataset.fontFamily,
                    textAlign: zone.dataset.textAlign || 'center',
                    verticalAlign: zone.dataset.verticalAlign || 'center'
                };
            });
            
            // Generate certificate for each row
            excelData.forEach((row, rowIndex) => {
                const certificate = document.createElement('div');
                certificate.className = 'certificate-preview';
                
                // Use IMG tag for background to ensure perfect scaling ratio
                const bgImg = document.createElement('img');
                bgImg.src = templateDataURL;
                bgImg.className = 'bg-img';
                certificate.appendChild(bgImg);
                
                // Add fields
                fieldConfigs.forEach(config => {
                    const field = document.createElement('div');
                    field.className = 'preview-field';
                    
                    // Apply Percentage Positions
                    field.style.left = config.leftPct + '%';
                    field.style.top = config.topPct + '%';
                    field.style.width = config.widthPct + '%';
                    field.style.height = config.heightPct + '%';
                    
                    // Apply Styles
                    field.style.fontSize = config.fontSize + 'px';
                    field.style.color = config.color;
                    field.style.fontFamily = config.fontFamily;
                    field.style.fontWeight = 'bold';
                    
                    // Apply Alignment
                    field.style.textAlign = config.textAlign;
                    field.style.alignItems = config.verticalAlign;
                    
                    if (config.textAlign === 'left' || config.textAlign === 'justify') {
                        field.style.justifyContent = 'flex-start';
                    } else if (config.textAlign === 'right') {
                        field.style.justifyContent = 'flex-end';
                    } else {
                        field.style.justifyContent = 'center';
                    }
                    
                    // Cikgu AI: Ensure text wraps within the box
                    field.textContent = row[config.headerIndex] || '';
                    
                    certificate.appendChild(field);
                });
                
                previewContainer.appendChild(certificate);
            });
            
            document.getElementById('previewCard').classList.remove('hidden');
            certificatesGenerated = true;
            
            showStatus(`Berjaya jana ${excelData.length} sijil!`, 'success');
        }

        // ============================================
        // PRINT & EXPORT
        // ============================================
        function printCertificates() {
            if (!certificatesGenerated) {
                showStatus('Sila jana preview sijil dahulu!', 'error');
                return;
            }
            window.print();
        }
        
        // Cikgu AI: Helper function untuk jana PDF dengan teks boleh edit
        async function createPDFDocument() {
            const { jsPDF } = window.jspdf;
            const previews = document.querySelectorAll('.certificate-preview');
            
            if (previews.length === 0) return null;

            // Get dimensions from first preview
            const firstContainer = previews[0];
            // Use container size (px) for coordinate mapping
            const pdfWidth = firstContainer.offsetWidth;
            const pdfHeight = firstContainer.offsetHeight;

            const doc = new jsPDF({ 
                orientation: pdfWidth > pdfHeight ? 'l' : 'p',
                unit: 'px',
                format: [pdfWidth, pdfHeight],
                compress: true
            });

            for (let i = 0; i < previews.length; i++) {
                if (i > 0) doc.addPage([pdfWidth, pdfHeight], pdfWidth > pdfHeight ? 'l' : 'p');

                const container = previews[i];
                const bgImg = container.querySelector('.bg-img');
                
                // Draw Background Image
                doc.addImage(bgImg, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                // Draw Text Fields as Vectors (Editable Text)
                const fields = container.querySelectorAll('.preview-field');
                
                fields.forEach(field => {
                    const style = window.getComputedStyle(field);
                    const text = field.innerText; // Use innerText to preserve newlines
                    
                    // Coordinates & Dimensions
                    const x = field.offsetLeft;
                    const y = field.offsetTop;
                    const w = field.offsetWidth;
                    const h = field.offsetHeight;
                    
                    // Styles
                    const fontSize = parseFloat(style.fontSize);
                    const color = style.color; // rgb()
                    const align = style.textAlign; // left, center, right
                    const vAlign = style.alignItems; // flex-start, center, flex-end
                    const fontFamily = style.fontFamily.toLowerCase();
                    const fontWeight = style.fontWeight;
                    
                    // Set Color
                    const rgb = color.match(/\d+/g);
                    if (rgb) doc.setTextColor(parseInt(rgb[0]), parseInt(rgb[1]), parseInt(rgb[2]));
                    
                    // Set Font (Basic Mapping to Standard PDF Fonts)
                    let pdfFont = 'helvetica';
                    if (fontFamily.includes('serif') && !fontFamily.includes('sans')) pdfFont = 'times';
                    if (fontFamily.includes('mono')) pdfFont = 'courier';
                    
                    let pdfType = 'normal';
                    if (fontWeight === 'bold' || parseInt(fontWeight) >= 600) pdfType = 'bold';
                    
                    doc.setFont(pdfFont, pdfType);
                    doc.setFontSize(fontSize);
                    
                    // Alignment Logic (X Coordinate)
                    let textX = x;
                    let pdfAlign = 'left';
                    
                    if (align === 'center') {
                        textX = x + (w / 2);
                        pdfAlign = 'center';
                    } else if (align === 'right') {
                        textX = x + w;
                        pdfAlign = 'right';
                    }
                    
                    // Text Wrapping & Vertical Alignment (Y Coordinate)
                    const lines = doc.splitTextToSize(text, w);
                    const lineHeight = fontSize * 1.15; // approximate line height
                    const blockHeight = lines.length * lineHeight;
                    
                    let textY = y;
                    
                    // Adjust Y based on vertical alignment
                    if (vAlign === 'center') {
                        textY = y + (h - blockHeight) / 2;
                        if (textY < y) textY = y; // Clamp top
                    } else if (vAlign === 'flex-end') {
                        textY = y + h - blockHeight;
                    }
                    
                    // Render Text
                    doc.text(lines, textX, textY, {
                        align: pdfAlign,
                        baseline: 'top',
                        lineHeightFactor: 1.15
                    });
                });
            }
            
            return doc;
        }

        async function downloadAsPDF() {
            if (!certificatesGenerated) {
                showStatus('Sila jana preview sijil dahulu!', 'error');
                return;
            }
            
            showStatus('‚è≥ Sedang menjana PDF (Teks Boleh Edit)...', 'info');
            await new Promise(r => setTimeout(r, 100));
            
            try {
                const doc = await createPDFDocument();
                if (doc) {
                    doc.save('Sijil-Pukal-Pro-Editable.pdf');
                    showStatus('‚úÖ PDF berjaya dimuat turun (Boleh Edit)!', 'success');
                }
            } catch (error) {
                console.error(error);
                showStatus('Ralat: ' + error.message, 'error');
            }
        }

        // Cikgu AI: Fungsi Share ke Media Sosial (Updated to use Editable PDF)
        async function shareCertificates() {
            if (!certificatesGenerated) {
                showStatus('Sila jana preview dahulu!', 'error');
                return;
            }

            if (!navigator.share) {
                showStatus('Pelayar anda tidak menyokong fungsi perkongsian web.', 'error');
                return;
            }

            try {
                showStatus('‚è≥ Sedang menjana fail untuk dikongsi...', 'info');
                await new Promise(resolve => setTimeout(resolve, 100));

                const doc = await createPDFDocument();
                
                if (doc) {
                    const pdfBlob = doc.output('blob');
                    const file = new File([pdfBlob], "Sijil-Pukal.pdf", { type: "application/pdf" });

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'Sijil Pukal Pro',
                            text: 'Berikut adalah fail sijil yang telah dijana (Boleh Edit).'
                        });
                        showStatus('‚úÖ Berjaya dikongsi!', 'success');
                    } else {
                        showStatus('Perkongsian fail tidak disokong pada peranti ini.', 'error');
                    }
                }
            } catch (err) {
                console.error(err);
                showStatus('Ralat perkongsian: ' + err.message, 'error');
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function clearAll() {
            document.getElementById('templateUpload').value = '';
            document.getElementById('excelUpload').value = '';
            document.getElementById('gSheetUrl').value = '';
            
            document.getElementById('certificateTemplate').src = '';
            document.getElementById('certificateTemplate').style.display = 'none';
            document.getElementById('templatePreviewContainer').classList.add('hidden');
            document.getElementById('excelStatus').classList.add('hidden');
            document.getElementById('excelStatus').innerHTML = '';
            document.getElementById('mappingSection').classList.add('hidden');
            document.getElementById('headersContainer').innerHTML = '';
            document.getElementById('previewContainer').innerHTML = '';
            document.getElementById('previewCard').classList.add('hidden');
            document.getElementById('styleEditor').classList.add('hidden');
            
            templateDataURL = null;
            excelData = null;
            headers = [];
            dropZones = [];
            certificatesGenerated = false;
            selectedDropZone = null;
            
            resetMapping();
            showStatus('Semua telah dikosongkan!', 'info');
        }

        function showStatus(message, type) {
            let statusDiv = document.getElementById('globalStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'globalStatus';
                statusDiv.style.position = 'fixed';
                statusDiv.style.top = '20px';
                statusDiv.style.right = '20px';
                statusDiv.style.zIndex = '1000';
                document.body.appendChild(statusDiv);
            }
            
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function setupDragDrop(elementId, callback) {
            const element = document.getElementById(elementId);
            
            element.addEventListener('dragover', function(e) {
                e.preventDefault();
                element.style.borderColor = '#10b981';
                element.style.backgroundColor = '#f0fdf4';
            });
            
            element.addEventListener('dragleave', function() {
                element.style.borderColor = '#3367d6';
                element.style.backgroundColor = '';
            });
            
            element.addEventListener('drop', function(e) {
                e.preventDefault();
                element.style.borderColor = '#3367d6';
                element.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length > 0) {
                    const event = { dataTransfer: e.dataTransfer };
                    callback(event);
                }
            });
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            }
        }
    </script>
</body>
</html>
